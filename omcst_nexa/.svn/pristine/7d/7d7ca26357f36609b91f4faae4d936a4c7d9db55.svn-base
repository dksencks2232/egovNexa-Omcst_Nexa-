<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="AnnualStat">

	<select id="annualStatDAO.selectAnnualStatList" resultClass="annualStatVO">
	<![CDATA[
		SELECT MEM.SEQ, MEM.NAME AS NAME, A.MEMBER_SEQ AS A_SEQ, A.WELFARE_CODE AS A_CODE, NVL(A.ANNUAL_COUNT, 0) AS ANNUAL
		        , B.MEMBER_SEQ AS B_SEQ, B.WELFARE_CODE AS B_CODE, NVL(B.VACATION_COUNT, 0) AS VACATION
		        , C.MEMBER_SEQ AS C_SEQ, C.WELFARE_CODE AS C_CODE, NVL(C.HALF_ANNUAL_COUNT, 0) AS HALFANNUAL
		        , (NVL(C.HALF_ANNUAL_COUNT, 0) + NVL(B.VACATION_COUNT, 0) + NVL(A.ANNUAL_COUNT, 0)) AS TOTAL
		        , D.BASIC_ANNUAL AS BASIC_ANNUAL
		FROM MEMBER MEM
		LEFT OUTER JOIN (
		    SELECT MEMBER_SEQ, WELFARE_CODE
		    		 , SUM(TO_DATE(ANNUAL_END, 'YYYY-MM-DD') - TO_DATE(ANNUAL_START, 'YYYY-MM-DD') + 1) AS ANNUAL_COUNT
		    FROM ANNUAL
		    WHERE WELFARE_CODE = 'ANNUAL'
		    AND USEYN = 'Y'
		    AND YEAR = EXTRACT(YEAR FROM SYSDATE)
		    GROUP BY MEMBER_SEQ, WELFARE_CODE
		    ORDER BY MEMBER_SEQ ASC, WELFARE_CODE ASC
		) A
		ON MEM.SEQ = A.MEMBER_SEQ
		LEFT OUTER JOIN (        
		    SELECT MEMBER_SEQ, WELFARE_CODE
		    		, SUM(TO_DATE(ANNUAL_END, 'YYYY-MM-DD') - TO_DATE(ANNUAL_START, 'YYYY-MM-DD') + 1) AS VACATION_COUNT
		    FROM ANNUAL
		    WHERE WELFARE_CODE = 'VACATION'
		    AND USEYN = 'Y'
		    AND YEAR = EXTRACT(YEAR FROM SYSDATE)
		    GROUP BY MEMBER_SEQ, WELFARE_CODE
		    ORDER BY MEMBER_SEQ ASC, WELFARE_CODE ASC
		) B
		ON MEM.SEQ = B.MEMBER_SEQ
		LEFT OUTER JOIN (        
		    SELECT MEMBER_SEQ, WELFARE_CODE
		    		, SUM(TO_DATE(ANNUAL_END, 'YYYY-MM-DD') - TO_DATE(ANNUAL_START, 'YYYY-MM-DD') + 0.5) AS HALF_ANNUAL_COUNT
		    FROM ANNUAL
		    WHERE WELFARE_CODE = 'HALFANNUAL'
		    AND USEYN = 'Y'
		    AND YEAR = EXTRACT(YEAR FROM SYSDATE)
		    GROUP BY MEMBER_SEQ, WELFARE_CODE
		    ORDER BY MEMBER_SEQ ASC, WELFARE_CODE ASC
		) C
		ON MEM.SEQ = C.MEMBER_SEQ
		LEFT OUTER JOIN (
					SELECT AA.SEQ, AA.NAME AS NAME, (AA.ANNUAN_BASIC + AA.BONUS_DAY) AS BASIC_ANNUAL
					FROM (
					        SELECT SEQ, FIRST_DAY, NAME
					                , 15 AS ANNUAN_BASIC, EXTRACT(YEAR FROM FIRST_DAY) AS FIRST_YEAR, EXTRACT(YEAR FROM SYSDATE) AS NOW_YEAR
					                , EXTRACT(YEAR FROM SYSDATE) - EXTRACT(YEAR FROM FIRST_DAY) AS WORK_YEAR
					                , TRUNC((EXTRACT(YEAR FROM SYSDATE) - EXTRACT(YEAR FROM FIRST_DAY) - 1) / 2) AS BONUS_DAY        
					        FROM MEMBER
					) AA
		) D
		ON MEM.SEQ = D.SEQ		
		ORDER BY MEM.SEQ ASC
	]]>
	</select>
	
	<select id="annualStatDAO.selectAnnualStatUserTotal" parameterClass="userVO" resultClass="annualStatVO">
	<![CDATA[
		SELECT MEM.SEQ, MEM.NAME AS NAME, A.MEMBER_SEQ AS A_SEQ, A.WELFARE_CODE AS A_CODE, NVL(A.ANNUAL_COUNT, 0) AS ANNUAL
		        , B.MEMBER_SEQ AS B_SEQ, B.WELFARE_CODE AS B_CODE, NVL(B.VACATION_COUNT, 0) AS VACATION
		        , C.MEMBER_SEQ AS C_SEQ, C.WELFARE_CODE AS C_CODE, NVL(C.HALF_ANNUAL_COUNT, 0) AS HALFANNUAL
		        , (NVL(C.HALF_ANNUAL_COUNT, 0) + NVL(B.VACATION_COUNT, 0) + NVL(A.ANNUAL_COUNT, 0)) AS TOTAL
		        , D.BASIC_ANNUAL AS BASIC_ANNUAL
		FROM MEMBER MEM
		LEFT OUTER JOIN (
		    SELECT MEMBER_SEQ, WELFARE_CODE
		    		 , SUM(TO_DATE(ANNUAL_END, 'YYYY-MM-DD') - TO_DATE(ANNUAL_START, 'YYYY-MM-DD') + 1) AS ANNUAL_COUNT
		    FROM ANNUAL
		    WHERE WELFARE_CODE = 'ANNUAL'
		    AND USEYN = 'Y'
		    AND YEAR = EXTRACT(YEAR FROM SYSDATE)
		    GROUP BY MEMBER_SEQ, WELFARE_CODE
		    ORDER BY MEMBER_SEQ ASC, WELFARE_CODE ASC
		) A
		ON MEM.SEQ = A.MEMBER_SEQ
		LEFT OUTER JOIN (        
		    SELECT MEMBER_SEQ, WELFARE_CODE
		    		, SUM(TO_DATE(ANNUAL_END, 'YYYY-MM-DD') - TO_DATE(ANNUAL_START, 'YYYY-MM-DD') + 1) AS VACATION_COUNT
		    FROM ANNUAL
		    WHERE WELFARE_CODE = 'VACATION'
		    AND USEYN = 'Y'
		    AND YEAR = EXTRACT(YEAR FROM SYSDATE)
		    GROUP BY MEMBER_SEQ, WELFARE_CODE
		    ORDER BY MEMBER_SEQ ASC, WELFARE_CODE ASC
		) B
		ON MEM.SEQ = B.MEMBER_SEQ
		LEFT OUTER JOIN (        
		    SELECT MEMBER_SEQ, WELFARE_CODE
		    	, SUM(TO_DATE(ANNUAL_END, 'YYYY-MM-DD') - TO_DATE(ANNUAL_START, 'YYYY-MM-DD') + 0.5) AS HALF_ANNUAL_COUNT
		    FROM ANNUAL
		    WHERE WELFARE_CODE = 'HALFANNUAL'
		    AND USEYN = 'Y'
		    AND YEAR = EXTRACT(YEAR FROM SYSDATE)
		    GROUP BY MEMBER_SEQ, WELFARE_CODE
		    ORDER BY MEMBER_SEQ ASC, WELFARE_CODE ASC
		) C
		ON MEM.SEQ = C.MEMBER_SEQ
		LEFT OUTER JOIN (
					SELECT AA.SEQ, AA.NAME AS NAME, (AA.ANNUAN_BASIC + AA.BONUS_DAY) AS BASIC_ANNUAL
					FROM (
					        SELECT SEQ, FIRST_DAY, NAME
					                , 15 AS ANNUAN_BASIC, EXTRACT(YEAR FROM FIRST_DAY) AS FIRST_YEAR, EXTRACT(YEAR FROM SYSDATE) AS NOW_YEAR
					                , EXTRACT(YEAR FROM SYSDATE) - EXTRACT(YEAR FROM FIRST_DAY) AS WORK_YEAR
					                , TRUNC((EXTRACT(YEAR FROM SYSDATE) - EXTRACT(YEAR FROM FIRST_DAY) - 1) / 2) AS BONUS_DAY        
					        FROM MEMBER
					) AA
		) D
		ON MEM.SEQ = D.SEQ
		WHERE MEM.SEQ = #SEQ#
		ORDER BY MEM.SEQ ASC
	]]>
	</select>	
</sqlMap>
